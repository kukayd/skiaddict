<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ski Addict Auto-Announce (Final V.4)</title>
    <style>
        :root {
            --main-white: #ffffff;
            --main-red: #f45157;
            --light-gray: #f8f9fa;
            --border-gray: #dee2e6;
            --text-dark: #343a40;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--main-white);
            color: var(--text-dark);
            padding: 20px;
            margin: 0 auto;
        }

        .container {
            background-color: var(--main-white);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.05);
            max-width: 1450px;
            margin: 0 auto;
            border: 1px solid var(--border-gray);
        }

        .header-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo-img {
            max-width: 250px;
            height: auto;
            margin-bottom: 15px;
        }

        h2 { 
            color: var(--main-red);
            margin: 0;
            font-weight: bold;
        }

        .status-bar {
            text-align: center;
            padding: 15px;
            margin-bottom: 25px;
            font-weight: bold;
            color: var(--text-dark);
            background: var(--light-gray);
            border-radius: 8px;
            border: 2px solid var(--border-gray);
        }

        .status-active { 
            background-color: #e8f5e9;
            color: #2e7d32;
            border-color: #a5d6a7;
        }
        
        /* YouTube Section Style */
        .youtube-section {
            background-color: #1a1a1a;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 20px;
            border: 2px solid #333;
        }
        .yt-controls {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .yt-iframe-container {
            width: 240px;
            height: 135px;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            flex-shrink: 0;
        }
        
        .yt-error-msg {
            color: #ff4444;
            font-size: 14px;
            margin-top: 5px;
            display: none;
            background: rgba(50,0,0,0.5);
            padding: 5px;
            border-radius: 4px;
        }

        .global-section {
            background-color: var(--light-gray);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px solid var(--main-red);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .grid-layout {
            display: grid;
            grid-template-columns: 40px 1fr 95px 50px 70px 60px 160px 90px 70px 50px;
            gap: 10px;
            align-items: center;
        }

        .row-header {
            padding: 15px;
            background: var(--main-red);
            color: white;
            border-radius: 8px 8px 0 0;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
        }
        
        .row-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-gray);
            background: var(--main-white);
        }
        .row-item:nth-child(even) { background-color: var(--light-gray); }
        
        input[type="text"], input[type="time"], select, input[type="number"] {
            padding: 10px;
            border: 1px solid var(--border-gray);
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
            text-align: center;
        }
        input[type="text"] { text-align: left; }

        .btn-test {
            background-color: var(--main-red);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
        }

        .btn-add {
            margin-top: 20px;
            background-color: white;
            color: var(--main-red);
            padding: 12px 25px;
            border: 2px solid var(--main-red);
            cursor: pointer;
            border-radius: 6px;
            font-weight: bold;
        }

        .btn-toggle {
            padding: 12px 35px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-start { background-color: #43a047; color: white; }
        .btn-stop { background-color: #d32f2f; color: white; }

        input[type="range"] { width: 100%; accent-color: var(--main-red); }
        .chk-container { display: flex; justify-content: center; align-items: center; flex-direction: column; }
        input[type="checkbox"] { transform: scale(1.4); cursor: pointer; }
        .small-label { font-size: 10px; color: #666; margin-top: 5px; }

        .btn-delete {
            background-color: transparent;
            color: #999;
            border: none;
            cursor: pointer;
            font-size: 18px;
        }
        .btn-delete:hover { color: var(--main-red); }
        
        label { font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <img src="SkiAddict Logo (4).png" alt="Ski Addict Logo" class="logo-img" onerror="this.style.display='none'">
        <h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ + YouTube (V.4 Final)</h2>
    </div>
    
    <div id="status-display" class="status-bar">
        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: üî¥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        <div id="clock" style="font-size: 1.4em; margin-top:10px; color: var(--main-red);">--:--:--</div>
        <div id="audio-status" style="font-size: 12px; color: #888; margin-top: 5px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>

    <div class="youtube-section">
        <div class="yt-iframe-container">
            <div id="player"></div>
        </div>
        <div class="yt-controls">
            <div style="font-size: 18px;">üì∫ <strong>YouTube Background Music</strong></div>
            
            <div style="display:flex; gap:10px; flex-wrap: wrap;">
                <input type="text" id="ytVideoId" placeholder="‡πÉ‡∏™‡πà YouTube Video ID (‡πÄ‡∏ä‡πà‡∏ô jfKfPfyJRdk)" value="jfKfPfyJRdk" style="text-align:left; flex-grow:1;">
                <button onclick="loadYoutubeVideo()" style="cursor:pointer; padding: 10px 20px; font-weight:bold; background:white; color:black; border:none; border-radius:4px;">Load Video</button>
            </div>
            
            <div id="yt-error-display" class="yt-error-msg"></div>

            <div style="margin-top:5px;">
                <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏•‡∏á (Volume): <span id="ytVolDisplay">30</span>%</label>
                <input type="range" id="ytVolume" min="0" max="100" value="30" oninput="updateYtVolume(this.value)">
            </div>
            
            <div style="font-size: 12px; color: #aaa; line-height: 1.4;">
                *‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ä‡πâ‡∏Ñ‡∏•‡∏¥‡∏õ "Lofi Girl" ‡∏´‡∏£‡∏∑‡∏≠ "No Copyright Music" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏≠‡∏î‡∏≥<br>
                **‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ‡πÅ‡∏ä‡πà‡πÑ‡∏ß‡πâ (‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏±‡∏ö‡∏à‡∏≠) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
            </div>
        </div>
    </div>

    <div class="global-section">
        <div style="flex-grow: 1;">
            <strong style="color: var(--main-red);">üéµ Intro Sound:</strong>
            <span id="file-name-display" style="margin-left: 10px; font-weight: bold; color: #333;">SkiAdict_Intro_Announce.m4a</span>
        </div>
        <div style="width: 200px;">
            <label style="font-size: 12px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î: <span id="speedVal">1.1</span>x</label>
            <input type="range" id="globalSpeed" min="0.5" max="2.0" step="0.1" value="1.1" oninput="updateSpeedLabel(this.value)">
        </div>
        <button id="toggleBtn" class="btn-toggle btn-start" onclick="toggleSystem()">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
    </div>

    <div class="grid-layout row-header">
        <div>#</div>
        <div>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</div>
        <div>‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤</div>
        <div>Loop</div>
        <div>‡∏ó‡∏∏‡∏Å(‡∏ô‡∏≤‡∏ó‡∏µ)</div>
        <div style="text-align:center;">‡∏Ç‡∏≤‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</div>
        <div>‡πÄ‡∏™‡∏µ‡∏¢‡∏á / ‡∏†‡∏≤‡∏©‡∏≤</div>
        <div>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏á</div>
        <div>Test</div>
        <div>‡∏•‡∏ö</div>
    </div>
    
    <div id="announcement-list"></div>

    <button class="btn-add" onclick="addRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
</div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
    // --- Global Variables ---
    let introBuffer = null;
    let audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let availableVoices = [];
    let isSystemRunning = false;
    let schedulerInterval = null;
    let rowCount = 0;
    
    // --- YouTube Variables ---
    let player;
    let ytTargetVolume = 30; 
    let fadeInterval = null;
    let isAnnouncing = false;

    // --- YouTube API Functions ---
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '100%',
            width: '100%',
            videoId: document.getElementById('ytVideoId').value,
            playerVars: {
                'playsinline': 1,
                'controls': 1,
                'rel': 0, // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏•‡∏¥‡∏õ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏≠‡∏ô‡∏à‡∏ö
                'fs': 0
            },
            events: {
                'onReady': onPlayerReady,
                'onError': onPlayerError,
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerReady(event) {
        player.setVolume(ytTargetVolume);
        const errDiv = document.getElementById('yt-error-display');
        errDiv.style.display = 'none';
        errDiv.innerText = "";
    }

    function onPlayerError(event) {
        const errDiv = document.getElementById('yt-error-display');
        let msg = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠";
        
        if(event.data === 100 || event.data === 101 || event.data === 150) {
            msg = "‚ùå ‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ô‡∏µ‡πâ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡∏Å‡∏±‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏ö‡∏ô‡πÄ‡∏ß‡πá‡∏ö‡∏≠‡∏∑‡πà‡∏ô (Embed Disabled) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà";
        } else if (event.data === 2) {
            msg = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Video ID ‡∏ô‡∏µ‡πâ (‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î)";
        }

        errDiv.innerText = msg;
        errDiv.style.display = 'block';
    }

    function onPlayerStateChange(event) {
        // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏õ‡∏à‡∏ö (Ended = 0) ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Manual Loop)
        if (event.data === YT.PlayerState.ENDED) {
            player.playVideo(); 
        }
    }

    function loadYoutubeVideo() {
        const vidId = document.getElementById('ytVideoId').value;
        if(player && vidId) {
            player.loadVideoById(vidId);
            document.getElementById('yt-error-display').style.display = 'none'; // Reset error
        }
    }

    function updateYtVolume(val) {
        ytTargetVolume = parseInt(val);
        document.getElementById('ytVolDisplay').innerText = val;
        if(player && !isAnnouncing) {
            player.setVolume(ytTargetVolume);
        }
    }

    // --- Audio Fading Logic ---
    function fadeOutYouTube(callback) {
        if (!player || !isSystemRunning || typeof player.setVolume !== 'function') { 
            if(callback) callback(); return; 
        }
        
        isAnnouncing = true;
        clearInterval(fadeInterval);
        let currentVol = player.getVolume();
        
        fadeInterval = setInterval(() => {
            currentVol -= 5; 
            if (currentVol <= 0) {
                currentVol = 0;
                player.setVolume(0);
                clearInterval(fadeInterval);
                if(callback) callback();
            } else {
                player.setVolume(currentVol);
            }
        }, 100); 
    }

    function fadeInYouTube() {
        if (!player || !isSystemRunning || typeof player.setVolume !== 'function') return;
        
        clearInterval(fadeInterval);
        let currentVol = 0;
        
        setTimeout(() => {
            fadeInterval = setInterval(() => {
                currentVol += 2; 
                if (currentVol >= ytTargetVolume) {
                    currentVol = ytTargetVolume;
                    player.setVolume(ytTargetVolume);
                    clearInterval(fadeInterval);
                    isAnnouncing = false;
                } else {
                    player.setVolume(currentVol);
                }
            }, 100);
        }, 1000); 
    }


    // --- Core Audio System ---
    function loadIntroFile() {
        const filePath = 'SkiAdict_Intro_Announce.m4a';
        fetch(filePath)
            .then(response => { if (!response.ok) throw new Error("File not found"); return response.arrayBuffer(); })
            .then(data => audioContext.decodeAudioData(data))
            .then(buffer => {
                introBuffer = buffer;
                document.getElementById('audio-status').innerText = "‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
                document.getElementById('audio-status').style.color = "#43a047";
            })
            .catch(err => {
                document.getElementById('audio-status').innerText = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå Intro (‡πÉ‡∏ä‡πâ TTS ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)";
            });
    }

    function loadVoices() {
        availableVoices = window.speechSynthesis.getVoices();
        document.querySelectorAll('.voice-select').forEach(select => {
            const currentVal = select.value;
            select.innerHTML = '';
            populateVoiceOptions(select);
            if(currentVal) select.value = currentVal;
        });
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;

    function populateVoiceOptions(selectElement) {
        availableVoices.sort((a, b) => {
            if(a.lang.includes('ja')) return -1;
            if(b.lang.includes('ja')) return 1;
            if(a.lang.includes('th')) return -1;
            if(b.lang.includes('th')) return 1;
            return 0;
        }).forEach((voice, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `${voice.name.substring(0, 20)} (${voice.lang})`;
            selectElement.appendChild(option);
        });
    }

    function updateSpeedLabel(val) {
        document.getElementById('speedVal').innerText = val;
        saveSettings();
    }

    function getSpokenTimeText(timeStr, langCode) {
        if(!timeStr) return "";
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();

        if (langCode.includes('ja')) return `„Åü„Å†„ÅÑ„Åæ„ÄÅ${hours}ÊôÇ${minutes > 0 ? minutes+'ÂàÜ' : ''}„Åß„Åô„ÄÇ`;
        if (langCode.includes('th')) return `‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡πÄ‡∏ß‡∏•‡∏≤ ${hours} ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ ${minutes > 0 ? minutes+'‡∏ô‡∏≤‡∏ó‡∏µ' : ''}`;
        return `The time is ${hours} ${minutes > 0 ? minutes : "o'clock"}`;
    }

    // --- Main Play Logic ---
    function playAudio(rowId) {
        if (audioContext.state === 'suspended') audioContext.resume();
        
        fadeOutYouTube(() => {
            executeAnnouncement(rowId);
        });
    }

    function executeAnnouncement(rowId) {
        const text = document.getElementById(`text-${rowId}`).value;
        const volume = document.getElementById(`vol-${rowId}`).value;
        const voiceIdx = document.getElementById(`voice-${rowId}`).value;
        const doAnnounceTime = document.getElementById(`announce-${rowId}`).checked;
        const speed = document.getElementById('globalSpeed').value;

        window.speechSynthesis.cancel();

        const utterQueue = [];

        if (doAnnounceTime) {
            const now = new Date();
            const curHM = now.getHours() + ":" + now.getMinutes();
            const uTime = new SpeechSynthesisUtterance(getSpokenTimeText(curHM, availableVoices[voiceIdx]?.lang || 'ja'));
            uTime.volume = volume; uTime.rate = speed;
            if(availableVoices[voiceIdx]) uTime.voice = availableVoices[voiceIdx];
            utterQueue.push(uTime);
        }

        const uText = new SpeechSynthesisUtterance(text);
        uText.volume = volume; uText.rate = speed;
        if(availableVoices[voiceIdx]) uText.voice = availableVoices[voiceIdx];
        
        uText.onend = () => {
             console.log("Announcement finished, fading in...");
             fadeInYouTube();
        };
        uText.onerror = () => { fadeInYouTube(); }; // ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß‡∏ñ‡πâ‡∏≤ error ‡∏Å‡πá‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏•‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤

        utterQueue.push(uText);

        const playQueue = () => {
            if(utterQueue.length > 0) {
                window.speechSynthesis.speak(utterQueue[0]);
                if(utterQueue.length > 1) {
                    utterQueue[0].onend = () => window.speechSynthesis.speak(utterQueue[1]);
                }
            } else {
                fadeInYouTube();
            }
        };

        if (introBuffer) {
            const source = audioContext.createBufferSource();
            source.buffer = introBuffer;
            source.connect(audioContext.destination);
            source.start(0);
            source.onended = playQueue;
        } else {
            playQueue();
        }
    }

    // --- Save/Load & Scheduler ---
    function saveSettings() {
        const data = [];
        document.querySelectorAll('.row-item').forEach(row => {
            const id = row.getAttribute('data-id');
            data.push({
                text: document.getElementById(`text-${id}`).value,
                time: document.getElementById(`time-${id}`).value,
                loop: document.getElementById(`loop-${id}`).checked,
                interval: document.getElementById(`interval-${id}`).value,
                announce: document.getElementById(`announce-${id}`).checked,
                voice: document.getElementById(`voice-${id}`).value,
                vol: document.getElementById(`vol-${id}`).value
            });
        });
        localStorage.setItem('skiAddictConfigV5', JSON.stringify({
            speed: document.getElementById('globalSpeed').value,
            ytId: document.getElementById('ytVideoId').value, 
            ytVol: document.getElementById('ytVolume').value,
            rows: data
        }));
    }

    function loadSettings() {
        const saved = localStorage.getItem('skiAddictConfigV5');
        if (saved) {
            const config = JSON.parse(saved);
            if(config.speed) {
                document.getElementById('globalSpeed').value = config.speed;
                document.getElementById('speedVal').innerText = config.speed;
            }
            if(config.ytId) {
                document.getElementById('ytVideoId').value = config.ytId;
            }
            if(config.ytVol) {
                document.getElementById('ytVolume').value = config.ytVol;
                updateYtVolume(config.ytVol);
            }

            if(config.rows && config.rows.length > 0) {
                config.rows.forEach(item => {
                    const id = addRow();
                    document.getElementById(`text-${id}`).value = item.text;
                    document.getElementById(`time-${id}`).value = item.time;
                    document.getElementById(`loop-${id}`).checked = item.loop;
                    document.getElementById(`interval-${id}`).value = item.interval || 60;
                    document.getElementById(`announce-${id}`).checked = item.announce;
                    document.getElementById(`vol-${id}`).value = item.vol;
                    setTimeout(() => { document.getElementById(`voice-${id}`).value = item.voice; }, 500);
                });
            } else { addRow(); }
        } else { addRow(); }
    }

    function addRow() {
        rowCount++;
        const id = rowCount;
        const div = document.createElement('div');
        div.className = 'grid-layout row-item';
        div.setAttribute('data-id', id);
        div.innerHTML = `
            <div style="font-weight:bold; color:var(--main-red);">${id}</div>
            <input type="text" id="text-${id}" value="Ski Addict ‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏ó‡πà‡∏≤‡∏ô" oninput="saveSettings()">
            <input type="time" id="time-${id}" oninput="saveSettings()">
            <div class="chk-container"><input type="checkbox" id="loop-${id}" onchange="saveSettings()"></div>
            <div><input type="number" id="interval-${id}" value="60" min="1" oninput="saveSettings()" title="Minutes"></div>
            <div class="chk-container"><input type="checkbox" id="announce-${id}" onchange="saveSettings()"><div class="small-label">On</div></div>
            <select id="voice-${id}" class="voice-select" onchange="saveSettings()"></select>
            <input type="range" id="vol-${id}" min="0.1" max="1" step="0.1" value="0.8" oninput="saveSettings()">
            <button class="btn-test" onclick="playAudio(${id})">Test</button>
            <button class="btn-delete" onclick="this.parentElement.remove(); saveSettings();">√ó</button>
        `;
        document.getElementById('announcement-list').appendChild(div);
        populateVoiceOptions(div.querySelector('.voice-select'));
        return id;
    }

    function toggleSystem() {
        if (audioContext.state === 'suspended') audioContext.resume();
        isSystemRunning = !isSystemRunning;
        const btn = document.getElementById('toggleBtn');
        const status = document.getElementById('status-display');
        
        if (isSystemRunning) {
            btn.innerText = "‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏∞‡∏ö‡∏ö"; btn.className = "btn-toggle btn-stop";
            status.classList.add("status-active");
            status.firstChild.textContent = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: üü¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (YouTube ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)";
            
            if(player && typeof player.playVideo === 'function') {
                player.playVideo();
                player.setVolume(ytTargetVolume);
            }

            schedulerInterval = setInterval(checkSchedule, 1000);
        } else {
            btn.innerText = "‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥"; btn.className = "btn-toggle btn-start";
            status.classList.remove("status-active");
            status.firstChild.textContent = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: üî¥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô";
            
            if(player && typeof player.pauseVideo === 'function') player.pauseVideo();
            
            clearInterval(schedulerInterval);
        }
    }

    function checkSchedule() {
        const now = new Date();
        const currentTotalMinutes = now.getHours() * 60 + now.getMinutes();
        const curSeconds = now.getSeconds();
        
        document.getElementById('clock').innerText = now.toLocaleTimeString('en-GB');
        
        if (curSeconds === 0 && !isAnnouncing) {
            document.querySelectorAll('.row-item').forEach(row => {
                const id = row.getAttribute('data-id');
                const timeStr = document.getElementById(`time-${id}`).value;
                if (!timeStr) return;

                const [startH, startM] = timeStr.split(':').map(Number);
                const startTotalMinutes = startH * 60 + startM;
                const isLoop = document.getElementById(`loop-${id}`).checked;
                const interval = parseInt(document.getElementById(`interval-${id}`).value) || 60;

                let shouldPlay = false;

                if (isLoop) {
                    let diff = currentTotalMinutes - startTotalMinutes;
                    if (diff < 0) diff += 1440;
                    if (diff >= 0 && diff % interval === 0) shouldPlay = true;
                } else {
                    if (currentTotalMinutes === startTotalMinutes) shouldPlay = true;
                }

                if (shouldPlay) {
                    playAudio(id);
                }
            });
        }
    }

    window.onload = () => {
        loadIntroFile();
        loadVoices();
        setTimeout(loadSettings, 1000);
    };
</script>
</body>
</html>
