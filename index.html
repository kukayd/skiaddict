<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ski Addict Auto-Announcement</title>
    <style>
        :root {
            --main-white: #ffffff;
            --main-red: #f45157;
            --light-gray: #f8f9fa;
            --border-gray: #dee2e6;
            --text-dark: #343a40;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--main-white);
            color: var(--text-dark);
            padding: 20px;
            margin: 0 auto;
        }

        .container {
            background-color: var(--main-white);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.05);
            max-width: 1300px;
            margin: 0 auto;
            border: 1px solid var(--border-gray);
        }

        .header-section {
            text-align: center;
            margin-bottom: 30px;
        }

        /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏™‡πà‡∏ß‡∏ô Logo */
        .logo-img {
            max-width: 250px;
            height: auto;
            margin-bottom: 15px;
        }

        h2 { 
            color: var(--main-red);
            margin: 0;
            font-weight: bold;
        }

        .status-bar {
            text-align: center;
            padding: 15px;
            margin-bottom: 25px;
            font-weight: bold;
            color: var(--text-dark);
            background: var(--light-gray);
            border-radius: 8px;
            border: 2px solid var(--border-gray);
        }

        .status-active { 
            background-color: #e8f5e9;
            color: #2e7d32;
            border-color: #a5d6a7;
        }
        
        .global-section {
            background-color: var(--light-gray);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px solid var(--main-red);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .grid-layout {
            display: grid;
            grid-template-columns: 40px 1fr 100px 60px 80px 180px 100px 100px 80px;
            gap: 10px;
            align-items: center;
        }

        .row-header {
            padding: 15px;
            background: var(--main-red);
            color: white;
            border-radius: 8px 8px 0 0;
            font-size: 14px;
            font-weight: bold;
        }
        
        .row-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-gray);
            background: var(--main-white);
        }
        .row-item:nth-child(even) { background-color: var(--light-gray); }
        
        input[type="text"], input[type="time"], select {
            padding: 10px;
            border: 1px solid var(--border-gray);
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
        }

        .btn-test {
            background-color: var(--main-red);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-add {
            margin-top: 20px;
            background-color: white;
            color: var(--main-red);
            padding: 12px 25px;
            border: 2px solid var(--main-red);
            cursor: pointer;
            border-radius: 6px;
            font-weight: bold;
        }

        .btn-toggle {
            padding: 12px 35px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 8px;
        }
        .btn-start { background-color: #43a047; color: white; }
        .btn-stop { background-color: #d32f2f; color: white; }

        input[type="range"] { width: 100%; accent-color: var(--main-red); }
        .chk-container { display: flex; justify-content: center; align-items: center; flex-direction: column; }
        input[type="checkbox"] { transform: scale(1.4); cursor: pointer; }
        .small-label { font-size: 10px; color: #666; margin-top: 5px; }

        .btn-delete {
            background-color: transparent;
            color: #999;
            border: none;
            cursor: pointer;
            font-size: 18px;
        }
        .btn-delete:hover { color: var(--main-red); }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <img src="SkiAddict Logo (4).png" alt="Ski Addict Logo" class="logo-img">
        <h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h2>
    </div>
    
    <div id="status-display" class="status-bar">
        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: üî¥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        <div id="clock" style="font-size: 1.4em; margin-top:10px; color: var(--main-red);">--:--:--</div>
    </div>

    <div class="global-section">
        <div style="flex-grow: 1;">
            <strong style="color: var(--main-red);">üéµ 1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Intro:</strong>
            <input type="file" id="introFile" accept="audio/*" style="margin-left: 10px;">
        </div>
        <div>
            <label style="font-size: 12px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Speed): <span id="speedVal">1.1</span>x</label>
            <input type="range" id="globalSpeed" min="0.5" max="2.0" step="0.1" value="1.1" oninput="updateSpeedLabel(this.value)">
        </div>
        <button id="toggleBtn" class="btn-toggle btn-start" onclick="toggleSystem()">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
    </div>

    <div class="grid-layout row-header">
        <div>#</div>
        <div>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</div>
        <div>‡πÄ‡∏ß‡∏•‡∏≤</div>
        <div style="text-align:center;">Loop</div>
        <div style="text-align:center;">‡∏Ç‡∏≤‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</div>
        <div>‡πÄ‡∏™‡∏µ‡∏¢‡∏á / ‡∏†‡∏≤‡∏©‡∏≤</div>
        <div>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏á</div>
        <div>Test</div>
        <div>‡∏•‡∏ö</div>
    </div>
    
    <div id="announcement-list"></div>

    <button class="btn-add" onclick="addRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
</div>

<script>
    let introBuffer = null;
    let audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let availableVoices = [];
    let isSystemRunning = false;
    let schedulerInterval = null;
    let rowCount = 0;

    // --- Core Functions ---
    function loadVoices() {
        availableVoices = window.speechSynthesis.getVoices();
        document.querySelectorAll('.voice-select').forEach(select => {
            const currentVal = select.value;
            select.innerHTML = '';
            populateVoiceOptions(select);
            if(currentVal) select.value = currentVal;
        });
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;

    function populateVoiceOptions(selectElement) {
        availableVoices.sort((a, b) => a.lang.includes('ja') ? -1 : 1).forEach((voice, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `${voice.name.substring(0, 15)} (${voice.lang})`;
            selectElement.appendChild(option);
        });
    }

    function updateSpeedLabel(val) {
        document.getElementById('speedVal').innerText = val;
        saveToLocal();
    }

    // --- Audio Logic ---
    document.getElementById('introFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(ev) {
                audioContext.decodeAudioData(ev.target.result, buffer => { introBuffer = buffer; });
            };
            reader.readAsArrayBuffer(file);
        }
    });

    function getSpokenTimeText(timeStr, langCode) {
        let [hours, minutes] = timeStr.split(':').map(Number);
        if (minutes > 30) { hours = (hours + 1) % 24; minutes = 0; }
        if (langCode.includes('ja')) return `„Åü„Å†„ÅÑ„Åæ„ÄÅ${hours}ÊôÇ„Åß„Åô„ÄÇ`;
        if (langCode.includes('th')) return `‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡πÄ‡∏ß‡∏•‡∏≤ ${hours} ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤`;
        return `The time is ${hours} o'clock`;
    }

    function playAudio(rowId) {
        if (audioContext.state === 'suspended') audioContext.resume();
        const text = document.getElementById(`text-${rowId}`).value;
        const volume = document.getElementById(`vol-${rowId}`).value;
        const voiceIdx = document.getElementById(`voice-${rowId}`).value;
        const timeVal = document.getElementById(`time-${rowId}`).value;
        const doAnnounceTime = document.getElementById(`announce-${rowId}`).checked;
        const speed = document.getElementById('globalSpeed').value;

        window.speechSynthesis.cancel();

        const speak = () => {
            if (doAnnounceTime && timeVal) {
                const uTime = new SpeechSynthesisUtterance(getSpokenTimeText(timeVal, availableVoices[voiceIdx]?.lang || 'ja'));
                uTime.volume = volume; uTime.rate = speed;
                if(availableVoices[voiceIdx]) uTime.voice = availableVoices[voiceIdx];
                window.speechSynthesis.speak(uTime);
            }
            const uText = new SpeechSynthesisUtterance(text);
            uText.volume = volume; uText.rate = speed;
            if(availableVoices[voiceIdx]) uText.voice = availableVoices[voiceIdx];
            window.speechSynthesis.speak(uText);
        };

        if (introBuffer) {
            const source = audioContext.createBufferSource();
            source.buffer = introBuffer;
            source.connect(audioContext.destination);
            source.start(0);
            source.onended = speak;
        } else { speak(); }
    }

    // --- Persistence (LocalStorage) ---
    function saveToLocal() {
        const data = [];
        document.querySelectorAll('.row-item').forEach(row => {
            const id = row.getAttribute('data-id');
            data.push({
                text: document.getElementById(`text-${id}`).value,
                time: document.getElementById(`time-${id}`).value,
                loop: document.getElementById(`loop-${id}`).checked,
                announce: document.getElementById(`announce-${id}`).checked,
                voice: document.getElementById(`voice-${id}`).value,
                vol: document.getElementById(`vol-${id}`).value
            });
        });
        localStorage.setItem('skiAddictSettings', JSON.stringify({
            speed: document.getElementById('globalSpeed').value,
            rows: data
        }));
    }

    function loadFromLocal() {
        const saved = localStorage.getItem('skiAddictSettings');
        if (saved) {
            const config = JSON.parse(saved);
            document.getElementById('globalSpeed').value = config.speed;
            document.getElementById('speedVal').innerText = config.speed;
            config.rows.forEach(item => {
                const id = addRow();
                document.getElementById(`text-${id}`).value = item.text;
                document.getElementById(`time-${id}`).value = item.time;
                document.getElementById(`loop-${id}`).checked = item.loop;
                document.getElementById(`announce-${id}`).checked = item.announce;
                document.getElementById(`vol-${id}`).value = item.vol;
                setTimeout(() => { document.getElementById(`voice-${id}`).value = item.voice; }, 500);
            });
        } else { addRow(); }
    }

    // --- UI Logic ---
    function addRow() {
        rowCount++;
        const id = rowCount;
        const div = document.createElement('div');
        div.className = 'grid-layout row-item';
        div.setAttribute('data-id', id);
        div.innerHTML = `
            <div style="font-weight:bold; color:var(--main-red);">${id}</div>
            <input type="text" id="text-${id}" value="Ski Addict „ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åó„Åü" oninput="saveToLocal()">
            <input type="time" id="time-${id}" oninput="saveToLocal()">
            <div class="chk-container"><input type="checkbox" id="loop-${id}" onchange="saveToLocal()"></div>
            <div class="chk-container"><input type="checkbox" id="announce-${id}" onchange="saveToLocal()"><div class="small-label">‡πÄ‡∏õ‡∏¥‡∏î</div></div>
            <select id="voice-${id}" class="voice-select" onchange="saveToLocal()"></select>
            <input type="range" id="vol-${id}" min="0.1" max="1" step="0.1" value="0.8" oninput="saveToLocal()">
            <button class="btn-test" onclick="playAudio(${id})">Test</button>
            <button class="btn-delete" onclick="this.parentElement.remove(); saveToLocal();">√ó</button>
        `;
        document.getElementById('announcement-list').appendChild(div);
        populateVoiceOptions(div.querySelector('.voice-select'));
        return id;
    }

    function toggleSystem() {
        isSystemRunning = !isSystemRunning;
        const btn = document.getElementById('toggleBtn');
        const status = document.getElementById('status-display');
        if (isSystemRunning) {
            btn.innerText = "‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏∞‡∏ö‡∏ö"; btn.className = "btn-toggle btn-stop";
            status.classList.add("status-active");
            schedulerInterval = setInterval(checkSchedule, 1000);
        } else {
            btn.innerText = "‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥"; btn.className = "btn-toggle btn-start";
            status.classList.remove("status-active");
            clearInterval(schedulerInterval);
        }
    }

    function checkSchedule() {
        const now = new Date();
        const curHM = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
        document.getElementById('clock').innerText = now.toLocaleTimeString('en-GB');
        if (now.getSeconds() === 0) {
            document.querySelectorAll('.row-item').forEach(row => {
                const id = row.getAttribute('data-id');
                const setTime = document.getElementById(`time-${id}`).value;
                const isLoop = document.getElementById(`loop-${id}`).checked;
                if (setTime === curHM || (isLoop && setTime.split(':')[1] === curHM.split(':')[1])) {
                    playAudio(id);
                }
            });
        }
    }

    loadVoices();
    setTimeout(loadFromLocal, 1000);
</script>
</body>
</html>